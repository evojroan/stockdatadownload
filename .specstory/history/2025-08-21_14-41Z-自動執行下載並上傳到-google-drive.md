<!-- Generated by SpecStory -->

# 自動執行下載並上傳到 Google Drive (2025-08-21 14:41Z)

_**User**_

我要部署到網路上，根據 cron 時間自動執行，且下載的檔案 (CSV)上傳到 Google drive。我有哪些方法？

---

_**Assistant**_

根據您的需求，要部署到網路上並根據 cron 時間自動執行，同時將 CSV 檔案上傳到 Google Drive，您有以下幾種方法：

## 主要部署選項：

### 1. **雲端平台部署 (推薦)**
- **Heroku**: 支援 cron jobs，有免費方案
- **Railway**: 簡單部署，支援 cron
- **Render**: 免費方案，支援 cron
- **Vercel**: 適合 Node.js 應用，支援 cron

### 2. **雲端服務器**
- **AWS EC2**: 完全控制，可設定 cron
- **Google Cloud Platform**: 整合 Google Drive API 方便
- **DigitalOcean**: 簡單易用，支援 cron

### 3. **容器化部署**
- **Docker + 雲端平台**: 可移植性高
- **Kubernetes**: 企業級解決方案

## 技術實現要點：

### Cron 自動化：
- 使用 `node-cron` 套件
- 雲端平台的內建 cron 功能
- 系統級 cron 任務

### Google Drive 整合：
- 使用 Google Drive API
- 需要 OAuth 2.0 認證
- 定期更新 access token

### 檔案處理：
- 下載 CSV 後立即上傳
- 設定檔案命名規則
- 處理重複檔案問題

您希望我幫您實作哪一種方案？或者您需要更詳細的技術說明？

---

_**User**_

所以我把本專案檔佈署到 Vercel 上就好了？

---

_**Assistant**_

讓我先檢查您的專案結構和程式碼，以確定是否適合部署到 Vercel。


---

Read file: app.js

---

Read file: package.json

---

**不建議直接部署到 Vercel！** 您的專案有以下問題：

## 主要問題：

### 1. **Playwright 瀏覽器依賴**
- Vercel 是無伺服器環境，無法執行完整的 Chromium 瀏覽器
- Playwright 需要系統級瀏覽器支援

### 2. **檔案系統操作**
- Vercel 的檔案系統是唯讀的，無法建立資料夾和儲存檔案
- 您的程式碼中有 `fs.mkdir()` 和檔案下載功能

### 3. **長時間執行**
- Vercel 有函數執行時間限制（通常 10-30 秒）
- 您的爬蟲程式需要較長時間執行

## 建議的替代方案：

### **Railway** (推薦)
- 支援完整的 Node.js 環境
- 可以執行 Playwright 和瀏覽器
- 有內建 cron 功能
- 支援檔案系統操作

### **Render**
- 類似 Railway，支援完整 Node.js 環境
- 有 cron 功能
- 免費方案可用

### **Heroku**
- 經典選擇，支援完整環境
- 需要信用卡驗證

您需要我幫您修改程式碼以適應這些平台嗎？

---

_**User**_

Zeabur 呢

---

_**Assistant**_

**Zeabur 也不適合您的專案！** 原因如下：

## Zeabur 的限制：

### 1. **無伺服器架構**
- 和 Vercel 一樣，Zeabur 主要用於靜態網站和 API 函數
- 不支援長時間運行的背景程序

### 2. **瀏覽器環境問題**
- 無法執行 Playwright 的 Chromium 瀏覽器
- 沒有完整的系統環境支援

### 3. **檔案系統限制**
- 無法建立資料夾和儲存 CSV 檔案
- 不支援持續性的檔案操作

## 總結各平台適合度：

### ❌ **不適合的平台：**
- **Vercel** - 無伺服器，無法執行瀏覽器
- **Zeabur** - 無伺服器，無法執行瀏覽器
- **Netlify** - 無伺服器，無法執行瀏覽器

### ✅ **適合的平台：**
- **Railway** - 完整 Node.js 環境，支援 Playwright
- **Render** - 完整 Node.js 環境，支援 Playwright  
- **Heroku** - 完整 Node.js 環境，支援 Playwright
- **DigitalOcean App Platform** - 完整環境支援

### 🔧 **需要修改的地方：**
- 將 Playwright 改為 headless 模式
- 整合 Google Drive API 上傳功能
- 移除本地檔案儲存，直接上傳到雲端

您希望我幫您修改程式碼以適應 Railway 或 Render 嗎？

---

_**User**_

GitHub Actions 呢

---

_**Assistant**_

**GitHub Actions 是很好的選擇！** 特別適合您的需求：

## GitHub Actions 的優勢：

### 1. **完全支援 Playwright**
- 有官方的 Playwright 動作
- 支援 headless 瀏覽器執行
- 可以安裝 Chromium 瀏覽器

### 2. **內建 Cron 功能**
- 使用 `schedule` 觸發器
- 可以設定每週一到五的 18:30 執行
- 週六 10:15 執行

### 3. **檔案處理靈活**
- 可以下載 CSV 檔案
- 支援多種雲端儲存整合
- 可以上傳到 Google Drive

### 4. **免費額度充足**
- 公開專案：無限分鐘
- 私人專案：每月 2000 分鐘
- 您的爬蟲程式執行時間在合理範圍內

## 實作方式：

### **工作流程結構：**
```yaml
name: Stock Data Crawler
on:
  schedule:
    - cron: '30 18 * * 1-5'  # 週一到五 18:30
    - cron: '15 10 * * 6'    # 週六 10:15
  workflow_dispatch:  # 手動觸發
```

### **執行環境：**
- Ubuntu 最新版本
- Node.js 18+
- Playwright 瀏覽器

### **整合選項：**
- Google Drive API 上傳
- 直接 commit 到專案
- 發送通知到 Discord/Slack

您希望我幫您建立 GitHub Actions 的設定檔嗎？這是最適合您需求的解決方案！

---

_**User**_

敘述說明如何使用 GitHub Actions

---

_**Assistant**_

## GitHub Actions 使用說明

### **1. 基本概念**
GitHub Actions 是 GitHub 的 CI/CD 平台，可以自動化執行您的程式碼。對於您的股票資料爬蟲，它會根據設定的時間自動執行，下載 CSV 檔案並上傳到 Google Drive。

### **2. 設定步驟**

#### **步驟 1：建立工作流程檔案**
在您的專案根目錄建立 `.github/workflows/` 資料夾，然後建立 `crawler.yml` 檔案：

```yaml
name: Stock Data Crawler
on:
  schedule:
    - cron: '30 18 * * 1-5'  # 週一到五 18:30 (台灣時間)
    - cron: '15 10 * * 6'     # 週六 10:15 (台灣時間)
  workflow_dispatch:           # 允許手動觸發

jobs:
  crawl-stock-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Run crawler
      run: node app.js
      
    - name: Upload to Google Drive
      # 這裡需要整合 Google Drive API
      run: echo "Upload to Google Drive"
```

#### **步驟 2：修改您的 app.js**
需要調整程式碼以適應 GitHub Actions 環境：

```javascript
// 修改瀏覽器啟動方式
const browser = await chromium.launch({
  headless: true,  // GitHub Actions 需要 headless 模式
  args: ['--no-sandbox', '--disable-setuid-sandbox']
});

// 移除本地檔案儲存，改為直接上傳到 Google Drive
// 或者將檔案 commit 到專案中
```

### **3. 時間設定說明**

#### **Cron 語法格式：**
```
分鐘 小時 日期 月份 星期
 30   18   *    *   1-5
```

- `30 18 * * 1-5` = 每天 18:30，但只在週一到週五執行
- `15 10 * * 6` = 每週六 10:15 執行

#### **台灣時間對應：**
- GitHub Actions 使用 UTC 時間
- 台灣時間 = UTC + 8
- 所以 18:30 台灣時間 = 10:30 UTC

### **4. 執行方式**

#### **自動執行：**
- 根據 cron 時間自動觸發
- 無需人工干預

#### **手動執行：**
- 在 GitHub 專案頁面點擊 "Actions" 標籤
- 選擇 "Stock Data Crawler" 工作流程
- 點擊 "Run workflow" 按鈕

### **5. 監控和除錯**

#### **查看執行狀態：**
- 在 Actions 頁面可以看到所有執行記錄
- 綠色勾勾 = 成功
- 紅色叉叉 = 失敗

#### **查看日誌：**
- 點擊失敗的執行記錄
- 展開各個步驟查看詳細日誌
- 可以下載完整的執行日誌

### **6. 進階功能**

#### **條件執行：**
```yaml
- name: Run crawler
  if: github.event_name == 'schedule'  # 只在排程時執行
  run: node app.js
```

#### **錯誤處理：**
```yaml
- name: Run crawler
  continue-on-error: true  # 即使失敗也繼續執行
  run: node app.js
```

#### **通知功能：**
```yaml
- name: Notify on failure
  if: failure()
  run: echo "Crawler failed!"
  # 可以整合 Discord/Slack 通知
```

### **7. 注意事項**

#### **免費額度：**
- 公開專案：無限分鐘
- 私人專案：每月 2000 分鐘
- 您的爬蟲程式執行時間約 5-10 分鐘/次

#### **安全性：**
- 敏感資訊（如 API 金鑰）要使用 GitHub Secrets
- 不要將密碼直接寫在程式碼中

#### **效能優化：**
- 使用 `actions/cache` 快取 node_modules
- 考慮使用 Docker 容器

這樣設定後，您的股票資料爬蟲就會按照設定的時間自動執行，完全不需要手動操作！

---

_**User**_

下載的檔案如何放到 Google Drive 指定資料夾

---

_**Assistant**_

## 將下載的 CSV 檔案上傳到 Google Drive 指定資料夾

### **1. 設定 Google Drive API**

#### **步驟 1：建立 Google Cloud 專案**
1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 建立新專案或選擇現有專案
3. 啟用 Google Drive API

#### **步驟 2：建立服務帳戶**
1. 在 IAM 與管理 → 服務帳戶中建立新帳戶
2. 下載 JSON 金鑰檔案
3. 將服務帳戶加入 Google Drive 資料夾的共用權限

### **2. 修改您的 app.js**

#### **安裝必要套件：**
```bash
npm install googleapis
```

#### **程式碼修改：**
```javascript
const {google} = require('googleapis');
const path = require('path');

// Google Drive 設定
const SCOPES = ['https://www.googleapis.com/auth/drive'];
const FOLDER_ID = '您的GoogleDrive資料夾ID'; // 從URL取得

// 建立 Google Drive 認證
async function createAuthClient() {
  const auth = new google.auth.GoogleAuth({
    keyFile: './google-credentials.json', // 服務帳戶金鑰檔案
    scopes: SCOPES,
  });
  return auth;
}

// 上傳檔案到 Google Drive
async function uploadToGoogleDrive(filePath, fileName) {
  try {
    const auth = await createAuthClient();
    const drive = google.drive({version: 'v3', auth});
    
    const fileMetadata = {
      name: fileName,
      parents: [FOLDER_ID] // 指定資料夾ID
    };
    
    const media = {
      mimeType: 'text/csv',
      body: require('fs').createReadStream(filePath)
    };
    
    const file = await drive.files.create({
      resource: fileMetadata,
      media: media,
      fields: 'id'
    });
    
    console.log(`檔案 ${fileName} 已上傳到 Google Drive，ID: ${file.data.id}`);
    return file.data.id;
  } catch (error) {
    console.error(`上傳 ${fileName} 時發生錯誤:`, error);
    throw error;
  }
}

// 修改下載函數，下載後立即上傳
async function downloadStockDataWeekday() {
  const browser = await chromium.launch({headless: true});
  const page = await browser.newPage();
  console.log("開始執行股票資料下載...");

  try {
    // 每日上市收盤價
    await page.goto("https://www.twse.com.tw/zh/trading/historical/mi-index.html");
    await page.selectOption("#label1", "ALLBUT0999");
    await page.click("button.search");
    await page.waitForTimeout(2000);

    let downloadPromise = page.waitForEvent("download");
    await page.click("button.csv");
    let download = await downloadPromise;
    
    // 建立暫存資料夾
    const tempDir = './temp';
    await fs.mkdir(tempDir, {recursive: true});
    
    // 下載到暫存位置
    const filePath = path.join(tempDir, `${todayDate}上市收盤價.csv`);
    await download.saveAs(filePath);
    
    // 上傳到 Google Drive
    await uploadToGoogleDrive(filePath, `${todayDate}上市收盤價.csv`);
    
    // 刪除暫存檔案
    await fs.unlink(filePath);
    
    // 重複相同流程處理其他檔案...
    
  } catch (error) {
    console.error("下載過程中發生錯誤:", error);
  } finally {
    await browser.close();
  }
}
```

### **3. GitHub Actions 整合**

#### **設定 Secrets：**
在 GitHub 專案設定 → Secrets and variables → Actions 中新增：
- `GOOGLE_CREDENTIALS`: 整個 JSON 金鑰檔案的內容

#### **修改工作流程：**
```yaml
name: Stock Data Crawler
on:
  schedule:
    - cron: '30 18 * * 1-5'
    - cron: '15 10 * * 6'
  workflow_dispatch:

jobs:
  crawl-stock-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Setup Google credentials
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > google-credentials.json
      
    - name: Run crawler
      run: node app.js
      
    - name: Cleanup
      run: rm -f google-credentials.json
```

### **4. 取得 Google Drive 資料夾 ID**

#### **方法 1：從 URL 取得**
1. 在 Google Drive 中開啟目標資料夾
2. URL 格式：`https://drive.google.com/drive/folders/FOLDER_ID`
3. 複製 `FOLDER_ID` 部分

#### **方法 2：使用 Google Drive API 查詢**
```javascript
// 列出所有資料夾
async function listFolders() {
  const auth = await createAuthClient();
  const drive = google.drive({version: 'v3', auth});
  
  const response = await drive.files.list({
    q: "mimeType='application/vnd.google-apps.folder'",
    fields: 'files(id, name)',
  });
  
  console.log('資料夾列表:', response.data.files);
}
```

### **5. 進階功能**

#### **檔案去重處理：**
```javascript
// 檢查檔案是否已存在
async function checkFileExists(fileName) {
  const auth = await createAuthClient();
  const drive = google.drive({version: 'v3', auth});
  
  const response = await drive.files.list({
    q: `name='${fileName}' and '${FOLDER_ID}' in parents`,
    fields: 'files(id, name)',
  });
  
  return response.data.files.length > 0;
}
```

#### **自動建立日期資料夾：**
```javascript
// 在 Google Drive 中建立日期資料夾
async function createDateFolder(dateString) {
  const auth = await createAuthClient();
  const drive = google.drive({version: 'v3', auth});
  
  const fileMetadata = {
    name: dateString,
    mimeType: 'application/vnd.google-apps.folder',
    parents: [FOLDER_ID]
  };
  
  const folder = await drive.files.create({
    resource: fileMetadata,
    fields: 'id'
  });
  
  return folder.data.id;
}
```

這樣設定後，您的 CSV 檔案就會自動下載並上傳到 Google Drive 的指定資料夾中！

---

